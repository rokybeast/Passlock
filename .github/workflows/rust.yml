name: Passlock CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: clippy, rustfmt

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install -y golang-go

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Auto-format code (optional)
      continue-on-error: true
      run: |
        echo "üìù Formatting Rust code with rustfmt..."
        cargo fmt
        
        # Show what changed
        git diff --name-only || echo "No changes or not in git repo"
        echo "‚úÖ Formatting complete (if any changes were made)"

    - name: Build project
      run: make build

    - name: Run Rust tests
      run: cargo test --verbose

    - name: Run C tests
      run: make test

    - name: Check Go API compilation
      working-directory: ./go_src
      run: |
        go build -o ../target/passlock-api api_server.go
        echo "‚úÖ Go API compiled successfully"

    - name: Linting with Clippy (warning only)
      continue-on-error: true
      run: |
        echo "üîç Running Clippy for code suggestions..."
        cargo clippy -- -D warnings || echo "‚ö†Ô∏è  Clippy found issues (check above)"

    - name: Verify build works
      run: |
        echo "üîß Checking basic functionality..."
        
        # Check binary exists
        if [ -f ./target/debug/passlock ]; then
          echo "‚úÖ Binary exists: ./target/debug/passlock"
          
          # Try to get version or help
          if ./target/debug/passlock --version 2>/dev/null; then
            echo "‚úÖ Version check passed"
          elif ./target/debug/passlock -h 2>/dev/null; then
            echo "‚úÖ Help command works"
          else
            echo "‚ö†Ô∏è  Binary exists but --version/-h didn't work"
          fi
        else
          # Try to find the binary
          echo "üîç Looking for binary..."
          find target -name "passlock" -type f 2>/dev/null | head -5
        fi
        
        echo "üéâ Build verification complete!"

  # Quick lint job (doesn't block main build)
  lint-only:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the whole workflow
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust tools
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: clippy, rustfmt
    
    - name: Format check (non-blocking)
      run: |
        echo "üìù Checking code formatting..."
        if cargo fmt -- --check; then
          echo "‚úÖ Code is properly formatted!"
        else
          echo "‚ö†Ô∏è  Code formatting issues found"
          echo "üí° Run 'cargo fmt' locally to fix"
          # Show what needs to be formatted
          cargo fmt -- --check 2>&1 | head -20
        fi
    
    - name: Clippy check (non-blocking)
      run: |
        echo "üîç Running Clippy lint check..."
        cargo clippy -- -D warnings 2>&1 | tail -20 || echo "‚ö†Ô∏è  Clippy found issues"