name: C CI
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
jobs:
  c-build-test:
    name: C Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        exclude:
          - os: macos-latest
            compiler: gcc
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install libsodium (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libsodium-dev

    - name: Install libsodium (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install libsodium
        echo "CPATH=/opt/homebrew/include:/usr/local/include:$CPATH" >> $GITHUB_ENV
        echo "LIBRARY_PATH=/opt/homebrew/lib:/usr/local/lib:$LIBRARY_PATH" >> $GITHUB_ENV

    - name: Set compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          echo "CC=gcc" >> $GITHUB_ENV
        else
          echo "CC=clang" >> $GITHUB_ENV
        fi

    - name: Build C vault engine
      run: |
        if [ -f src/c/vault_engine.c ]; then
          cd src/c
          $CC -c vault_engine.c -I. -fPIC -Wall -Wextra -O3
          echo "vault_engine.c compiled successfully"
        else
          echo "vault_engine.c not found, skipping"
        fi
        
        if [ -f src/c/crypto_core.c ]; then
          cd src/c
          $CC -c crypto_core.c -I. -fPIC -Wall -Wextra -O3
          echo "crypto_core.c compiled successfully"
        else
          echo "crypto_core.c not found, skipping"
        fi

    - name: Run C tests (crypto_core)
      run: |
        if [ -f src/c/crypto_core.c ]; then
          $CC -DTEST_MODE -o test_crypto src/c/crypto_core.c -Wall -Wextra
          ./test_crypto
          rm -f test_crypto
          echo "C tests passed"
        else
          echo "crypto_core.c not found, skipping tests"
        fi

    - name: Test with different optimization levels
      run: |
        if [ -f src/c/crypto_core.c ]; then
          echo "Testing -O0 (no optimization)"
          $CC -DTEST_MODE -O0 -o test_crypto_o0 src/c/crypto_core.c -Wall -Wextra
          ./test_crypto_o0
          rm -f test_crypto_o0
          
          echo "Testing -O2"
          $CC -DTEST_MODE -O2 -o test_crypto_o2 src/c/crypto_core.c -Wall -Wextra
          ./test_crypto_o2
          rm -f test_crypto_o2
          
          echo "Testing -O3"
          $CC -DTEST_MODE -O3 -o test_crypto_o3 src/c/crypto_core.c -Wall -Wextra
          ./test_crypto_o3
          rm -f test_crypto_o3
          
          echo "All optimization levels passed"
        else
          echo "crypto_core.c not found, skipping optimization tests"
        fi

    - name: Check for memory leaks (valgrind on Linux)
      if: runner.os == 'Linux' && matrix.compiler == 'gcc'
      run: |
        if [ -f src/c/crypto_core.c ]; then
          sudo apt-get install -y valgrind
          $CC -DTEST_MODE -g -o test_crypto src/c/crypto_core.c -Wall -Wextra
          valgrind --leak-check=full --error-exitcode=1 ./test_crypto
          rm -f test_crypto
          echo "No memory leaks detected"
        else
          echo "crypto_core.c not found, skipping valgrind"
        fi

    - name: Static analysis (cppcheck)
      if: runner.os == 'Linux'
      run: |
        if [ -d src/c ]; then
          sudo apt-get install -y cppcheck
          # Run cppcheck with suppression for unusedFunction in vault_engine.c
          cppcheck --enable=all \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction:src/c/vault_engine.c \
                   --error-exitcode=1 \
                   src/c/
          echo "Static analysis passed"
        else
          echo "src/c not found, skipping cppcheck"
        fi